<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown & LaTeX 渲染测试</title>
    
    <!-- 引入必要的CSS和JS库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9fafb;
        }
        
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100vh;
        }
        
        .editor-panel, .preview-panel {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
        }
        
        .editor-panel h3, .preview-panel h3 {
            margin-top: 0;
            color: #1f2937;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 8px;
        }
        
        #markdown-input {
            width: 100%;
            height: calc(100% - 60px);
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 12px;
            resize: none;
            outline: none;
        }
        
        #markdown-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }
        
        .preview-content {
            height: calc(100% - 60px);
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 12px;
            background: white;
        }
        
        /* Markdown content styles */
        .markdown-content h1, .markdown-content h2, .markdown-content h3, .markdown-content h4, .markdown-content h5, .markdown-content h6 {
            margin-top: 1.5em !important;
            margin-bottom: 0.5em !important;
            font-weight: bold !important;
            color: #1f2937 !important;
        }
        
        .markdown-content h1 {
            font-size: 2em !important;
            border-bottom: 2px solid #e5e7eb !important;
            padding-bottom: 0.3em !important;
        }
        
        .markdown-content h2 {
            font-size: 1.5em !important;
            border-bottom: 1px solid #e5e7eb !important;
            padding-bottom: 0.3em !important;
        }
        
        .markdown-content h3 {
            font-size: 1.25em !important;
        }
        
        .markdown-content h4 {
            font-size: 1.125em !important;
        }
        
        .markdown-content h5 {
            font-size: 1em !important;
        }
        
        .markdown-content h6 {
            font-size: 0.875em !important;
        }
        
        .markdown-content p {
            margin-bottom: 1em;
        }
        
        .markdown-content strong, .markdown-content b {
            font-weight: bold !important;
        }
        
        .markdown-content em, .markdown-content i {
            font-style: italic !important;
        }
        
        .markdown-content pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            overflow-x: auto;
        }
        
        .markdown-content code {
            background-color: #f8f9fa;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875em;
        }
        
        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1rem;
            margin: 1rem 0;
            font-style: italic;
            color: #6b7280;
        }
        
        .markdown-content ul, .markdown-content ol {
            margin: 1em 0;
            padding-left: 2em;
        }
        
        .markdown-content li {
            margin: 0.5em 0;
        }
        
        /* LaTeX math styling */
        .katex-display {
            margin: 1em 0 !important;
            text-align: center !important;
            overflow-x: auto !important;
        }
        
        .katex {
            font-size: 1.1em;
        }
        
        /* Error styling */
        .text-red-500 {
            color: #ef4444;
        }
        
        .bg-red-50 {
            background-color: #fef2f2;
        }
        
        .px-1 {
            padding-left: 0.25rem;
            padding-right: 0.25rem;
        }
        
        .rounded {
            border-radius: 0.25rem;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .border {
            border-width: 1px;
        }
        
        .border-red-200 {
            border-color: #fecaca;
        }
    </style>
</head>
<body>
    <h1>Markdown & LaTeX 渲染测试</h1>
    
    <div class="container">
        <div class="editor-panel">
            <h3>编辑器 (输入Markdown)</h3>
            <textarea id="markdown-input" placeholder="在这里输入Markdown内容..."># 测试标题 H1

## 二级标题 H2

### 三级标题 H3

这是一个**粗体文本**和*斜体文本*的示例。

这是行内数学公式：$E = mc^2$

这是包含换行的数学公式：$a \n b$

这是块级数学公式：

$$\begin{cases} 
x = f(u,v) \n
y = g(u,v) 
\end{cases}$$

换行测试：

$$a \n b \n c$$

- 列表项目 1
- 列表项目 2
  - 嵌套项目
- 列表项目 3

代码块示例：

```javascript
function hello() {
  console.log("Hello, World!");
}
```

> 这是一个引用块
> 可以有多行内容</textarea>
        </div>
        
        <div class="preview-panel">
            <h3>预览效果</h3>
            <div id="preview-content" class="preview-content markdown-content"></div>
        </div>
    </div>

    <script>
        // 渲染函数 - 简单直接处理，先Markdown后LaTeX，并清理<br>
        function renderMarkdown(text) {
            if (!text) return '';
            
            console.log('Original content:', text);
            
            // Step 1: Process markdown first
            marked.setOptions({
                highlight: (code, lang) => {
                    if (lang && hljs.getLanguage(lang)) {
                        return hljs.highlight(code, { language: lang }).value;
                    }
                    return hljs.highlightAuto(code).value;
                },
                breaks: true,
                gfm: true
            });
            
            let html = marked.parse(text);
            console.log('After marked:', html);
            
            // Step 2: Process LaTeX and clean up <br> tags inside math
            
            // Handle block math ($$...$$)
            html = html.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
                try {
                    // Clean up <br> tags that Marked added
                    let mathContent = math.replace(/<br\s*\/?>/g, '').trim();
                    console.log('Processing block math:', mathContent);
                    
                    // Handle \n line breaks
                    if (mathContent.includes('\\n')) {
                        const parts = mathContent.split(/\s*\\n\s*/);
                        if (parts.length > 1) {
                            mathContent = `\\begin{array}{c} ${parts.join(' \\\\ ')} \\end{array}`;
                            console.log('Converted \\n to array:', mathContent);
                        }
                    }
                    
                    return `<div class="katex-display">${katex.renderToString(mathContent, { 
                        displayMode: true,
                        throwOnError: false,
                        strict: false,
                        trust: true
                    })}</div>`;
                } catch (e) {
                    console.error('Block math error:', e);
                    return `<div class="text-red-500 p-2 bg-red-50 border border-red-200 rounded">LaTeX Error: ${e.message}</div>`;
                }
            });
            
            // Handle inline math with \n ($...\n...$)
            html = html.replace(/\$([^$]*\\n[^$]*)\$/g, (match, math) => {
                try {
                    // Clean up <br> tags
                    let mathContent = math.replace(/<br\s*\/?>/g, '').trim();
                    console.log('Processing inline break math:', mathContent);
                    
                    const parts = mathContent.split(/\s*\\n\s*/);
                    if (parts.length > 1) {
                        const arrayContent = `\\begin{array}{c} ${parts.join(' \\\\ ')} \\end{array}`;
                        console.log('Converted to array:', arrayContent);
                        
                        return `<div class="katex-display">${katex.renderToString(arrayContent, { 
                            displayMode: true,
                            throwOnError: false,
                            strict: false,
                            trust: true
                        })}</div>`;
                    } else {
                        return katex.renderToString(mathContent, { 
                            displayMode: false,
                            throwOnError: false,
                            strict: false,
                            trust: true
                        });
                    }
                } catch (e) {
                    console.error('Inline linebreak math error:', e);
                    return `<span class="text-red-500 bg-red-50 px-1 rounded text-sm">LaTeX Error: ${e.message}</span>`;
                }
            });
            
            // Handle simple inline math ($...$)
            html = html.replace(/\$([^$\n\\]+?)\$/g, (match, math) => {
                try {
                    const mathContent = math.trim();
                    console.log('Processing inline math:', mathContent);
                    
                    return katex.renderToString(mathContent, { 
                        displayMode: false,
                        throwOnError: false,
                        strict: false,
                        trust: true
                    });
                } catch (e) {
                    console.error('Inline math error:', e);
                    return `<span class="text-red-500 bg-red-50 px-1 rounded text-sm">LaTeX Error: ${e.message}</span>`;
                }
            });
            
            console.log('Final HTML:', html);
            return html;
        }
        
        // 更新预览
        function updatePreview() {
            const input = document.getElementById('markdown-input');
            const preview = document.getElementById('preview-content');
            const html = renderMarkdown(input.value);
            preview.innerHTML = html;
        }
        
        // 绑定事件
        document.getElementById('markdown-input').addEventListener('input', updatePreview);
        
        // 初始渲染
        updatePreview();
    </script>
</body>
</html>